/*!
 * pixi-tilemap - v1.0.1
 * Compiled Mon Oct 10 2016 01:35:41 GMT+0300 (RTZ 2 (зима))
 *
 * pixi-tilemap is licensed under the MIT License.
 * http://www.opensource.org/licenses/mit-license
 */
!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,(t.pixiTilemap||(t.pixiTilemap={})).min=e()}}(function(){return function e(t,r,i){function n(o,s){if(!r[o]){if(!t[o]){var h="function"==typeof require&&require;if(!s&&h)return h(o,!0);if(a)return a(o,!0);var u=new Error("Cannot find module '"+o+"'");throw u.code="MODULE_NOT_FOUND",u}var l=r[o]={exports:{}};t[o][0].call(l.exports,function(e){var r=t[o][1][e];return n(r?r:e)},l,l.exports,e,t,r,i)}return r[o].exports}for(var a="function"==typeof require&&require,o=0;o<i.length;o++)n(i[o]);return n}({1:[function(e,t,r){function i(e){this.renderer=e,this.tileAnim=[0,0]}PIXI.CanvasRenderer.registerPlugin("tile",i),t.exports=i},{}],2:[function(e,t,r){function i(){PIXI.Container.apply(this,arguments),this.initialize.apply(this,arguments)}var n=e("./RectTileLayer");i.prototype=Object.create(PIXI.Container.prototype),i.prototype.constructor=n,i.prototype.updateTransform=i.prototype.displayObjectUpdateTransform,i.prototype.initialize=function(e,t,r,i){this.z=this.zIndex=e,this.useSquare=r,this.shadowColor=new Float32Array([0,0,0,.5]),this.texPerChild=i||16,t&&this.setBitmaps(t)},i.prototype.setBitmaps=function(e){var t,r=this.texPerChild,i=this.children.length,a=Math.ceil(e.length/r);for(t=0;t<i;t++)this.children[t].textures=e.slice(t*r,(t+1)*r);for(t=i;t<a;t++)this.addChild(new n(this.zIndex,e.slice(t*r,(t+1)*r)))},i.prototype.clear=function(){for(var e=0;e<this.children.length;e++)this.children[e].clear();this.modificationMarker=0},i.prototype.addRect=function(e,t,r,i,n,a,o){this.children[e]&&this.children[e].textures&&this.children[e].addRect(0,t,r,i,n,a,o)},i.prototype.addFrame=function(e,t,r){"string"==typeof e&&(e=PIXI.Texture.fromImage(e));for(var i=this.children,a=null,o=0,s=0;s<i.length;s++){for(var h=i[s].textures,u=0;u<h.length;u++)if(h[u].baseTexture==e.baseTexture){a=i[s],o=u;break}if(a)break}if(!a){for(s=0;s<i.length;s++){var l=i[s];l.textures.length<16&&(a=l,o=l.textures.length,l.textures.push(e))}a||(i.push(a=new n(this.zIndex,e)),o=0)}return a.addRect(o,e.frame.x,e.frame.y,t,r,e.frame.width,e.frame.height),!0},i.prototype.renderCanvas=function(e){if(!e.dontUseTransform){var t=this.worldTransform;e.context.setTransform(t.a,t.b,t.c,t.d,t.tx*e.resolution,t.ty*e.resolution)}for(var r=this.children,i=0;i<r.length;i++)r[i].renderCanvas(e)},i.prototype.renderWebGL=function(e){var t=(e.gl,e.plugins.tile.getShader(this.useSquare));if(e.setObjectRenderer(e.plugins.tile),e.bindShader(t),this._globalMat=this._globalMat||new PIXI.Matrix,e._activeRenderTarget.projectionMatrix.copy(this._globalMat).append(this.worldTransform),t.uniforms.projectionMatrix=this._globalMat.toArray(!0),t.uniforms.shadowColor=this.shadowColor,this.useSquare){var r=this._tempScale=this._tempScale||[0,0];r[0]=this._globalMat.a>=0?1:-1,r[1]=this._globalMat.d<0?1:-1;t.uniforms.pointScale=r;t.uniforms.projectionScale=Math.abs(this.worldTransform.a)*e.resolution}for(var i=(t.uniforms.animationFrame=e.plugins.tile.tileAnim,this.children),n=0;n<i.length;n++)i[n].renderWebGL(e,this.useSquare)},i.prototype.isModified=function(e){var t=this.children;if(this.modificationMarker!=t.length)return!0;for(var r=0;r<t.length;r++)if(t[r].modificationMarker!=t[r].pointsBuf.length||e&&t[r].hasAnim)return!0;return!1},i.prototype.clearModify=function(){var e=this.children;this.modificationMarker=e.length;for(var t=0;t<e.length;t++)e[t].modificationMarker=e[t].pointsBuf.length},t.exports=i},{"./RectTileLayer":4}],3:[function(e,t,r){function i(e){PIXI.Graphics.apply(this,arguments),this.z=this.zIndex=e}i.prototype=Object.create(PIXI.Graphics.prototype),i.prototype.constructor=i,i.prototype.renderCanvas=function(e){var t=null;e.dontUseTransform&&(t=this.transform.worldTransform,this.transform.worldTransform=PIXI.Matrix.IDENTITY),e.plugins.graphics.render(this),e.dontUseTransform&&(this.transform.worldTransform=t),e.context.globalAlpha=1},i.prototype.renderWebGL=function(e){this._webGL[e.gl.id]||(this.dirty=!0),PIXI.Graphics.prototype.renderWebGL.call(this,e)},i.prototype.isModified=function(e){return!1},i.prototype.clearModify=function(){},t.exports=i},{}],4:[function(e,t,r){function i(e,t){PIXI.DisplayObject.apply(this,arguments),this.initialize.apply(this,arguments)}i.prototype=Object.create(PIXI.DisplayObject.prototype),i.prototype.constructor=i,i.prototype.initialize=function(e,t){t?t instanceof Array||!t.baseTexture||(t=[t]):t=[],this.textures=t,this.z=this.zIndex=e,this.pointsBuf=[],this.visible=!1,this._tempSize=new Float32Array([0,0]),this._tempTexSize=1},i.prototype.clear=function(){this.pointsBuf.length=0,this.modificationMarker=0,this.hasAnim=!1},i.prototype.renderCanvas=function(e){if(0!==this.textures.length){var t=this.pointsBuf;e.context.fillStyle="#000000";for(var r=0,i=t.length;r<i;r+=9){var n=t[r],a=t[r+1],o=t[r+2],s=t[r+3],h=t[r+4],u=t[r+5];n+=t[r+6]*e.plugins.tile.tileAnim[0],a+=t[r+7]*e.plugins.tile.tileAnim[1];var l=t[r+8];l>=0?e.context.drawImage(this.textures[l].baseTexture.source,n,a,h,u,o,s,h,u):(e.context.globalAlpha=.5,e.context.fillRect(o,s,h,u),e.context.globalAlpha=1)}}},i.prototype.addRect=function(e,t,r,i,n,a,o,s,h){var u=this.pointsBuf;if(this.hasAnim=this.hasAnim||s>0||h>0,a==o)u.push(t),u.push(r),u.push(i),u.push(n),u.push(a),u.push(o),u.push(0|s),u.push(0|h),u.push(e);else{var l;if(a%o===0)for(l=0;l<a/o;l++)u.push(t+l*o),u.push(r),u.push(i+l*o),u.push(n),u.push(o),u.push(o),u.push(0|s),u.push(0|h),u.push(e);else if(o%a===0)for(l=0;l<o/a;l++)u.push(t),u.push(r+l*a),u.push(i),u.push(n+l*a),u.push(a),u.push(a),u.push(0|s),u.push(0|h),u.push(e);else u.push(t),u.push(r),u.push(i),u.push(n),u.push(a),u.push(o),u.push(0|s),u.push(0|h),u.push(e)}},i.prototype.renderWebGL=function(e,t){var r=this.pointsBuf;if(0!==r.length){var i=r.length/9,n=e.plugins.tile,a=e.gl;t||n.checkIndexBuffer(i);var o=n.getShader(t),s=this.textures;if(0!==s.length){var h=s.length;this._tempTexSize<o.maxTextures&&(this._tempTexSize=o.maxTextures,this._tempSize=new Float32Array(2*o.maxTextures));for(var u=0;u<h;u++){if(!s[u]||!s[u].valid)return;s[u].baseTexture}n.bindTextures(e,s);var l=n.getVb(this.vbId);l||(l=n.createVb(t),this.vbId=l.id,this.vbBuffer=null,this.modificationMarker=0);l.vao.bind();l=l.vb,l.bind();var d=i*o.vertPerQuad;if(0!==d){if(this.modificationMarker!=d){this.modificationMarker=d;var p=o.stride*d;if(!this.vbBuffer||this.vbBuffer.byteLength<p){for(var c=o.stride;c<p;)c*=2;this.vbBuffer=new ArrayBuffer(c),this.vbArray=new Float32Array(this.vbBuffer),this.vbInts=new Uint32Array(this.vbBuffer),l.upload(this.vbBuffer,0,!0)}var f,v,m,x=this.vbArray,y=(this.vbInts,0);if(t)for(u=0;u<r.length;u+=9)f=r[u+8]>>2,v=1024*(1&r[u+8]),m=1024*(r[u+8]>>1&1),x[y++]=r[u+2],x[y++]=r[u+3],x[y++]=r[u+0]+v,x[y++]=r[u+1]+m,x[y++]=r[u+4],x[y++]=r[u+6],x[y++]=r[u+7],x[y++]=f;else{for(u=0;u<r.length;u+=9){var g=.5;f=r[u+8]>>2,v=1024*(1&r[u+8]),m=1024*(r[u+8]>>1&1);var b=r[u+2],T=r[u+3],I=r[u+4],S=r[u+5],A=r[u]+v,C=r[u+1]+m,L=r[u+6],P=r[u+7];x[y++]=b,x[y++]=T,x[y++]=A,x[y++]=C,x[y++]=A+g,x[y++]=C+g,x[y++]=A+I-g,x[y++]=C+S-g,x[y++]=L,x[y++]=P,x[y++]=f,x[y++]=b+I,x[y++]=T,x[y++]=A+I,x[y++]=C,x[y++]=A+g,x[y++]=C+g,x[y++]=A+I-g,x[y++]=C+S-g,x[y++]=L,x[y++]=P,x[y++]=f,x[y++]=b+I,x[y++]=T+S,x[y++]=A+I,x[y++]=C+S,x[y++]=A+g,x[y++]=C+g,x[y++]=A+I-g,x[y++]=C+S-g,x[y++]=L,x[y++]=P,x[y++]=f,x[y++]=b,x[y++]=T+S,x[y++]=A,x[y++]=C+S,x[y++]=A+g,x[y++]=C+g,x[y++]=A+I-g,x[y++]=C+S-g,x[y++]=L,x[y++]=P,x[y++]=f}}l.upload(x,0,!0)}t?a.drawArrays(a.POINTS,0,d):a.drawElements(a.TRIANGLES,6*i,a.UNSIGNED_SHORT,0)}}}},t.exports=i},{}],5:[function(e,t,r){function i(e,t){PIXI.Shader.call(this,e,"#define GLSLIFY 1\nattribute vec2 aVertexPosition;\nattribute vec2 aTextureCoord;\nattribute vec4 aFrame;\nattribute vec2 aAnim;\nattribute float aTextureId;\n\nuniform mat3 projectionMatrix;\nuniform vec2 animationFrame;\n\nvarying vec2 vTextureCoord;\nvarying float vTextureId;\nvarying vec4 vFrame;\n\nvoid main(void){\n   gl_Position = vec4((projectionMatrix * vec3(aVertexPosition, 1.0)).xy, 0.0, 1.0);\n   vec2 anim = aAnim * animationFrame;\n   vTextureCoord = aTextureCoord + anim;\n   vFrame = aFrame + vec4(anim, anim);\n   vTextureId = aTextureId;\n}\n",n.generateFragmentSrc(t,"#define GLSLIFY 1\nvarying vec2 vTextureCoord;\nvarying vec4 vFrame;\nvarying float vTextureId;\nuniform vec4 shadowColor;\nuniform sampler2D uSamplers[%count%];\nuniform vec2 uSamplerSize[%count%];\n\nvoid main(void){\n   vec2 textureCoord = clamp(vTextureCoord, vFrame.xy, vFrame.zw);\n   float textureId = floor(vTextureId + 0.5);\n\n   vec4 color;\n   %forloop%\n   gl_FragColor = color;\n}\n")),this.maxTextures=t,this.vertSize=11,this.vertPerQuad=4,this.stride=4*this.vertSize,n.fillSamplers(this,this.maxTextures)}var n=e("./shaderGenerator");i.prototype=Object.create(PIXI.Shader.prototype),i.prototype.constructor=i,i.prototype.createVao=function(e,t){var r=e.gl;return e.createVao().addIndex(this.indexBuffer).addAttribute(t,this.attributes.aVertexPosition,r.FLOAT,!1,this.stride,0).addAttribute(t,this.attributes.aTextureCoord,r.FLOAT,!1,this.stride,8).addAttribute(t,this.attributes.aFrame,r.FLOAT,!1,this.stride,16).addAttribute(t,this.attributes.aAnim,r.FLOAT,!1,this.stride,32).addAttribute(t,this.attributes.aTextureId,r.FLOAT,!1,this.stride,40)},t.exports=i},{"./shaderGenerator":9}],6:[function(e,t,r){function i(e,t){PIXI.Shader.call(this,e,"#define GLSLIFY 1\nattribute vec2 aVertexPosition;\nattribute vec2 aTextureCoord;\nattribute vec2 aAnim;\nattribute float aTextureId;\nattribute float aSize;\n\nuniform mat3 projectionMatrix;\nuniform vec2 samplerSize;\nuniform vec2 animationFrame;\nuniform float projectionScale;\n\nvarying vec2 vTextureCoord;\nvarying float vSize;\nvarying float vTextureId;\n\nvoid main(void){\n   gl_Position = vec4((projectionMatrix * vec3(aVertexPosition + aSize * 0.5, 1.0)).xy, 0.0, 1.0);\n   gl_PointSize = aSize * projectionScale;\n   vTextureCoord = aTextureCoord + aAnim * animationFrame;\n   vTextureId = aTextureId;\n   vSize = aSize;\n}\n",n.generateFragmentSrc(t,"#define GLSLIFY 1\nvarying vec2 vTextureCoord;\nvarying float vSize;\nvarying float vTextureId;\n\nuniform vec4 shadowColor;\nuniform sampler2D uSamplers[%count%];\nuniform vec2 uSamplerSize[%count%];\nuniform vec2 pointScale;\n\nvoid main(void){\n   float margin = 0.5 / vSize;\n   vec2 pointCoord = (gl_PointCoord - 0.5) * pointScale + 0.5;\n   vec2 clamped = vec2(clamp(pointCoord.x, margin, 1.0 - margin), clamp(pointCoord.y, margin, 1.0 - margin));\n   vec2 textureCoord = pointCoord * vSize + vTextureCoord;\n   float textureId = vTextureId;\n   vec4 color;\n   %forloop%\n   gl_FragColor = color;\n}\n")),this.maxTextures=t,this.vertSize=8,this.vertPerQuad=1,this.stride=4*this.vertSize,n.fillSamplers(this,this.maxTextures)}var n=e("./shaderGenerator");i.prototype=Object.create(PIXI.Shader.prototype),i.prototype.constructor=i,i.prototype.createVao=function(e,t){var r=e.gl;return e.createVao().addIndex(this.indexBuffer).addAttribute(t,this.attributes.aVertexPosition,r.FLOAT,!1,this.stride,0).addAttribute(t,this.attributes.aTextureCoord,r.FLOAT,!1,this.stride,8).addAttribute(t,this.attributes.aSize,r.FLOAT,!1,this.stride,16).addAttribute(t,this.attributes.aAnim,r.FLOAT,!1,this.stride,20).addAttribute(t,this.attributes.aTextureId,r.FLOAT,!1,this.stride,28)},t.exports=i},{"./shaderGenerator":9}],7:[function(e,t,r){function i(e){PIXI.ObjectRenderer.call(this,e),this.vbs={},this.lastTimeCheck=0,this.tileAnim=[0,0],this.maxTextures=4,this.indices=[],this.indexBuffer=null}var n=e("./RectTileShader"),a=e("./SquareTileShader"),o=PIXI.glCore;i.prototype=Object.create(PIXI.ObjectRenderer.prototype),i.prototype.constructor=i,i.vbAutoincrement=0,i.SCALE_MODE=PIXI.SCALE_MODES.DEFAULT,i.prototype.onContextChange=function(){var e=this.renderer.gl,t=this.maxTextures;this.rectShader=new n(e,t),this.squareShader=new a(e,t),this.checkIndexBuffer(2e3),this.rectShader.indexBuffer=this.indexBuffer,this.squareShader.indexBuffer=this.indexBuffer,this.vbs={},this.glTextures=[],this.boundSprites=[],this.initBounds()},i.prototype.initBounds=function(){var e=this.renderer.gl,t=document.createElement("canvas");t.width=2048,t.height=2048;for(var r=0;r<this.maxTextures;r++){var n=new o.GLTexture(e);n.premultiplyAlpha=!0,n.upload(t),n.enableWrapClamp(),i.SCALE_MODE===PIXI.SCALE_MODES.LINEAR?n.enableLinearScaling():n.enableNearestScaling(),this.glTextures.push(n);for(var a=[],s=0;s<4;s++){var h=new PIXI.Sprite;h.position.x=1024*(1&s),h.position.y=1024*(s>>1),a.push(h)}this.boundSprites.push(a)}},o.GLTexture.prototype._hackSubImage=function(e){this.bind();var t=this.gl,r=e.texture.baseTexture;t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1),t.texSubImage2D(t.TEXTURE_2D,0,e.position.x,e.position.y,this.format,this.type,r.source)},i.prototype.bindTextures=function(e,t){var r=this.boundSprites,i=this.glTextures,n=t.length,a=this.maxTextures;if(!(n>=4*a)){var o;for(o=0;o<n;o++){var s=t[o];if(e.bindTexture(s),s&&t[o].valid){var h=r[o>>2][3&o];if(!h.texture||h.texture.baseTexture!==s.baseTexture){h.texture=s;var u=i[o>>2];u._hackSubImage(h)}}}for(o=0;o<a;o++)i[o].bind(o);e._activeTextureLocation=a-1}},i.prototype.checkLeaks=function(){var e=Date.now(),t=e-1e4;if(this.lastTimeCheck<t||this.lastTimeCheck>e){this.lastTimeCheck=e;var r=this.vbs;for(var i in r)r[i].lastTimeAccess<t&&this.removeVb(i)}},i.prototype.start=function(){this.renderer.state.setBlendMode(PIXI.BLEND_MODES.NORMAL)},i.prototype.getVb=function(e){this.checkLeaks();var t=this.vbs[e];return t?(t.lastAccessTime=Date.now(),t):null},i.prototype.createVb=function(e){var t=++i.vbAutoincrement,r=this.getShader(e),n=this.renderer.gl,a=PIXI.glCore.GLBuffer.createVertexBuffer(n,null,n.STREAM_DRAW),o={id:t,vb:a,vao:r.createVao(this.renderer,a),lastTimeAccess:Date.now(),useSquare:e,shader:r};return this.vbs[t]=o,o},i.prototype.removeVb=function(e){this.vbs[e]&&(this.vbs[e].vb.destroy(),this.vbs[e].vao.destroy(),delete this.vbs[e])},i.prototype.checkIndexBuffer=function(e){var t=6*e,r=this.indices;if(!(t<=r.length)){for(var i=r.length||t;i<t;)i<<=1;r=new Uint16Array(i),this.indices=r;for(var n=0,a=0;n+5<r.length;n+=6,a+=4)r[n+0]=a+0,r[n+1]=a+1,r[n+2]=a+2,r[n+3]=a+0,r[n+4]=a+2,r[n+5]=a+3;if(this.indexBuffer)this.indexBuffer.upload(r);else{var s=this.renderer.gl;this.indexBuffer=o.GLBuffer.createIndexBuffer(s,this.indices,s.STATIC_DRAW)}}},i.prototype.getShader=function(e){return e?this.squareShader:this.rectShader},i.prototype.destroy=function(){PIXI.ObjectRenderer.prototype.destroy.call(this),this.rectShader.destroy(),this.squareShader.destroy(),this.rectShader=null,this.squareShader=null},PIXI.WebGLRenderer.registerPlugin("tile",i),t.exports=i},{"./RectTileShader":5,"./SquareTileShader":6}],8:[function(e,t,r){function i(){this.initialize.apply(this,arguments)}i.prototype=Object.create(PIXI.Container.prototype),i.prototype.initialize=function(e,t){PIXI.Container.apply(this,arguments),this.tilemap=e,this.z=t},i.prototype.clear=function(){for(var e=this.children,t=0;t<e.length;t++)e[t].clear();this._previousLayers=0},i.prototype.cacheIfDirty=function(){var e=this.tilemap,t=this.children,r=this._previousLayers!=t.length;this._previousLayers=t.length;var i=this.canvasBuffer,n=this._tempRender;i||(i=this.canvasBuffer=document.createElement("canvas"),n=this._tempRender=new PIXI.CanvasRenderer(100,100,{view:i}),n.context=n.rootContext,n.dontUseTransform=!0),i.width==e._layerWidth&&i.height==e._layerHeight||(i.width=e._layerWidth,i.height=e._layerHeight,r=!0);var a;if(!r)for(a=0;a<t.length;a++)if(t[a].isModified(this._lastAnimationFrame!=e.animationFrame)){r=!0;break}if(this._lastAnimationFrame=e.animationFrame,r)for(e._hackRenderer&&e._hackRenderer(n),n.context.clearRect(0,0,i.width,i.height),a=0;a<t.length;a++)t[a].clearModify(),t[a].renderCanvas(n);for(this.layerTransform=this.worldTransform,a=0;a<t.length;a++){this.layerTransform=t[a].worldTransform;break}},i.prototype.renderCanvas=function(e){this.cacheIfDirty();var t=this.layerTransform;e.context.setTransform(t.a,t.b,t.c,t.d,t.tx*e.resolution,t.ty*e.resolution);this.tilemap;e.context.drawImage(this.canvasBuffer,0,0)},t.exports=i},{}],9:[function(e,t,r){var i={fillSamplers:function(e,t){for(var r=[],i=0;i<t;i++)r[i]=i;e.bind(),e.uniforms.uSamplers=r;var n=[];for(i=0;i<t;i++)n.push(1/2048),n.push(1/2048);e.uniforms.uSamplerSize=n},generateFragmentSrc:function(e,t){return t.replace(/%count%/gi,e).replace(/%forloop%/gi,this.generateSampleSrc(e))},generateSampleSrc:function(e){var t="";t+="\n",t+="\n",t+="if(vTextureId <= -1.0) {",t+="\n\tcolor = shadowColor;",t+="\n}";for(var r=0;r<e;r++)t+="\nelse ",r<e-1&&(t+="if(textureId == "+r+".0)"),t+="\n{",t+="\n\tcolor = texture2D(uSamplers["+r+"], textureCoord * uSamplerSize["+r+"]);",t+="\n}";return t+="\n",t+="\n"}};t.exports=i},{}],10:[function(e,t,r){PIXI.tilemap={ZLayer:e("./ZLayer"),GraphicsLayer:e("./GraphicsLayer"),RectTileLayer:e("./RectTileLayer"),CompositeRectTileLayer:e("./CompositeRectTileLayer"),CanvasTileRenderer:e("./CanvasTileRenderer"),TileRenderer:e("./TileRenderer")},t.exports=PIXI.tilemap},{"./CanvasTileRenderer":1,"./CompositeRectTileLayer":2,"./GraphicsLayer":3,"./RectTileLayer":4,"./TileRenderer":7,"./ZLayer":8}]},{},[10])(10)});